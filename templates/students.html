<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students List</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        /* Container */
        .container {
            padding: 40px;
        }

        /* Search + Filters */
        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .controls input, .controls select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            width: 200px;
        }

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 15px;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        th {
            cursor: pointer;
            background: #4a60ff;
            color: white;
        }
        tr:hover {
            background: #f1f1f1;
        }

        /* Buttons */
        .btn {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-edit { background-color: #f0ad4e; color: white; }
        .btn-delete { background-color: #d9534f; color: white; }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="logo">Student Management</div>
        <ul class="nav-links">
            <li><a href="/">Dashboard</a></li>
            <li><a href="/students">Students</a></li>
            <li><a href="/add_student">Add Student</a></li>
        </ul>
    </nav>

    <div class="container">
        <h2>Students List</h2>

        <!-- Search + Filter Menu -->
        <div class="controls">
            <input type="text" id="searchBox" placeholder="Search student...">

            <select id="branchFilter">
                <option value="">Filter by Branch</option>
            </select>

            <select id="yearFilter">
                <option value="">Filter by Year</option>
            </select>
        </div>

        <!-- Table -->
        <table id="students-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th onclick="sortTable('name')">Name ⬍</th>
                    <th onclick="sortTable('roll')">Roll ⬍</th>
                    <th onclick="sortTable('branch')">Branch ⬍</th>
                    <th onclick="sortTable('year')">Year ⬍</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

<script>
    let allStudents = [];
    let sortOrder = { name: 1, roll: 1, branch: 1, year: 1 };

    // Fetch all students
    async function fetchStudents() {
        try {
            const response = await fetch('/api/students');
            allStudents = await response.json();

            populateFilters();
            renderTable(allStudents);
        } catch (error) {
            console.error("Error fetching students:", error);
        }
    }

    // Render table rows dynamically
    function renderTable(data) {
        const tbody = document.querySelector('#students-table tbody');
        tbody.innerHTML = "";

        data.forEach(student => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${student.id}</td>
                <td>${student.name}</td>
                <td>${student.roll}</td>
                <td>${student.branch}</td>
                <td>${student.year}</td>
                <td>
                    <button class="btn btn-edit" onclick="editStudent(${student.id})">Edit</button>
                    <button class="btn btn-delete" onclick="deleteStudent(${student.id})">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Search functionality
    document.getElementById('searchBox').addEventListener('input', function () {
        const value = this.value.toLowerCase();
        const filtered = allStudents.filter(s =>
            s.name.toLowerCase().includes(value) ||
            s.roll.toLowerCase().includes(value) ||
            s.branch.toLowerCase().includes(value) ||
            s.year.toLowerCase().includes(value)
        );
        renderTable(filtered);
    });

    // Populate filters dynamically
    function populateFilters() {
        const branchSet = new Set(allStudents.map(s => s.branch));
        const yearSet = new Set(allStudents.map(s => s.year));

        const branchFilter = document.getElementById('branchFilter');
        const yearFilter = document.getElementById('yearFilter');

        branchFilter.innerHTML = `<option value="">Filter by Branch</option>`;
        yearFilter.innerHTML = `<option value="">Filter by Year</option>`;

        branchSet.forEach(b => {
            branchFilter.innerHTML += `<option value="${b}">${b}</option>`;
        });

        yearSet.forEach(y => {
            yearFilter.innerHTML += `<option value="${y}">${y}</option>`;
        });
    }

    // Filter event listeners
    document.getElementById('branchFilter').addEventListener('change', applyFilters);
    document.getElementById('yearFilter').addEventListener('change', applyFilters);

    function applyFilters() {
        const branch = document.getElementById('branchFilter').value;
        const year = document.getElementById('yearFilter').value;

        let filtered = allStudents;

        if (branch) filtered = filtered.filter(s => s.branch === branch);
        if (year) filtered = filtered.filter(s => s.year === year);

        renderTable(filtered);
    }

    // Sorting function
    function sortTable(field) {
        sortOrder[field] *= -1; // Toggle ASC/DESC

        allStudents.sort((a, b) => {
            if (a[field] < b[field]) return -1 * sortOrder[field];
            if (a[field] > b[field]) return 1 * sortOrder[field];
            return 0;
        });

        renderTable(allStudents);
    }

    // Edit placeholder
    function editStudent(id) {
        alert(`Edit feature coming soon for ID: ${id}`);
    }

    // Delete student
    async function deleteStudent(id) {
        if (!confirm("Are you sure you want to delete this student?")) return;

        try {
            const response = await fetch(`/api/students/${id}`, { method: "DELETE" });
            const data = await response.json();
            alert(data.message);

            fetchStudents(); // refresh
        } catch (error) {
            console.error("Error deleting student:", error);
        }
    }

    // Load data
    fetchStudents();
</script>

</body>
</html>
